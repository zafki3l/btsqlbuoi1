CREATE DATABASE QLHOCVIEN

USE QLHOCVIEN

-- TAO BANG STUDENT --
CREATE TABLE STUDENT
(
	RN INT PRIMARY KEY,
	studentName VARCHAR(20),
	Age TINYINT
)

-- TAO BANG TEST --
CREATE TABLE TEST
(
	testID INT PRIMARY KEY,
	subjectName VARCHAR(20)
)

-- TAO BANG STUDENT TEST --
CREATE TABLE STUDENTTEST
(
	RN INT,
	CONSTRAINT FK1_STUDENTTEST FOREIGN KEY (RN) REFERENCES STUDENT(RN),
	testID INT,
	CONSTRAINT FK2_STUDENTTEST FOREIGN KEY (testID) REFERENCES TEST(testID),
	testDate DATETIME,
	Mark FLOAT
)

-- CHEN DU LIEU VAO BANG TEST --
INSERT INTO TEST(testID, subjectName) 
VALUES
(1, 'EPC'),
(2, 'DWMX'),
(3, 'SQL1'),
(4, 'SQL2')

-- CHEN DU LIEU VAO BANG STUDENT --
INSERT INTO STUDENT(RN, studentName, Age)
VALUES
(1, 'Nguyen Hong Ha', 20),
(2, 'Truong Ngoc Anh', 30),
(3, 'Tuan Minh', 25),
(4, 'Dan Truong', 22)

-- CHEN DU LIEU VAO BANG STUDENT TEST --
INSERT INTO STUDENTTEST(RN, testID, testDate, Mark)
VALUES
(1, 1, '2006-7-17', 8),
(1, 2, '2006-7-18', 5),
(1, 3, '2006-7-19', 7),
(2, 1, '2006-7-17', 7),
(2, 2, '2006-7-18', 4),
(2, 3, '2006-7-19', 2),
(3, 1, '2006-7-17', 10),
(3, 3, '2016-7-18', 1)

-- XEM BANG --
SELECT * FROM STUDENT
SELECT * FROM TEST
SELECT * FROM STUDENTTEST

-- CAU 2: DUA RA TUOI TRUNG BINH CAC HOC VIEN --
SELECT AVG(Age) AS [TUOI TRUNG BINH] FROM STUDENT

-- CAU 3: TIM RA HOC VIEN CO TUOI CAO NHAT --
SELECT * FROM STUDENT WHERE Age = (SELECT MAX(Age) FROM STUDENT)

-- CAU 4: TINH TONG TUOI CUA CAC HOC VIEN --
SELECT SUM(Age) AS [TONG TUOI] FROM STUDENT

-- CAU 5: TINH XEM MOI HOC VIEN DA THI DUOC BAO NHIEU NGAY ROI --
SELECT STUDENT.RN, studentName, COUNT(DISTINCT testDate) AS [SO NGAY THI]
FROM STUDENT JOIN STUDENTTEST
ON STUDENT.RN = STUDENTTEST.RN
GROUP BY STUDENT.RN, studentName

-- CAU 6: TIM RA NHUNG HOC VIEN DAT DIEM CAO NHAT --
SELECT STUDENT.RN, studentName, Mark FROM STUDENTTEST
JOIN STUDENT
ON STUDENT.RN = STUDENTTEST.RN
WHERE Mark = (SELECT MAX(Mark) FROM STUDENTTEST)

-- CAU 7: DUA RA DIEM HOC VIEN DUOI DANG 4 CHU SO, 2 CHU SO DANG SAU DAU PHAY --
SELECT STUDENT.RN, studentName, CONVERT (DECIMAL(4,2), MARK) AS [DIEM HOC VIEN]
FROM STUDENTTEST JOIN STUDENT
ON STUDENT.RN = STUDENTTEST.RN

-- CAU 8: HIEN THI DANH SACH CAC HOC VIEN DA THAM GIA THI --
SELECT studentName, subjectName, Mark, testDate
FROM STUDENT
JOIN STUDENTTEST
ON STUDENT.RN = STUDENTTEST.RN
JOIN TEST
ON TEST.testID = STUDENTTEST.testID

-- CAU 9: HIEN THI DANH SACH HOC VIEN CHUA THI MON NAO --
SELECT * FROM STUDENT
WHERE RN NOT IN(SELECT DISTINCT RN FROM STUDENTTEST)

-- CAU 10: HIEN THI DANH SACH HOC VIEN PHAI THI LAI --
SELECT studentName, subjectName, Mark, testDate
FROM STUDENTTEST
JOIN STUDENT
ON STUDENTTEST.RN = STUDENT.RN
JOIN TEST
ON STUDENTTEST.testID = TEST.testID
WHERE Mark < 5

-- CAU 11: SAP XEP DANH SACH HOC VIEN THEO DIEM TB GIAM DAN --
SELECT STUDENT.studentName, AVG(STUDENTTEST.Mark) AS [AVERAGE]
FROM STUDENTTEST JOIN STUDENT
ON STUDENTTEST.RN = STUDENT.RN
GROUP BY STUDENT.studentName
ORDER BY AVG(STUDENTTEST.Mark) DESC

-- CAU 12: HIEN THI TEN VA DIEM CUA HOC VIEN CO DIEM TB CAO NHAT --
SELECT TOP 1 STUDENT.studentName, AVG(STUDENTTEST.Mark) AS [AVERAGE]
FROM STUDENT JOIN STUDENTTEST ON STUDENT.RN = STUDENTTEST.RN
GROUP BY STUDENT.studentName

-- CAU 13: HIEN THI DIEM THI CAO NHAT CUA TUNG MON HOC --
SELECT TEST.subjectName, MAX(STUDENTTEST.Mark) AS [DIEM CAO NHAT]
FROM STUDENTTEST JOIN TEST
ON STUDENTTEST.testID = TEST.testID
GROUP BY TEST.subjectName

-- CAU 14: IF AGE < 30 = YOUNG, ELSE = OLD --
SELECT RN, studentName, Age, CASE
WHEN Age < 30 THEN 'YOUNG'
ELSE 'OLD'
END AS [STATUS]
FROM STUDENT