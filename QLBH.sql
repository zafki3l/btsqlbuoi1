CREATE DATABASE QLBH

USE QLBH

-- TAO BANG KHACH HANG --
CREATE TABLE KHACHHANG
(
    maKH int PRIMARY KEY,
    Ten varchar(50),
    Tuoi int,
    diaChi varchar(30)
)

-- TAO BANG HOA DON --
CREATE TABLE HOADON
(
    maHD int PRIMARY KEY,
    maKH int,
    CONSTRAINT FK_HOADON FOREIGN KEY (maKH) REFERENCES KHACHHANG(maKH),
    ngayMua datetime,
    tongTien int
)

-- TAO BANG SAN PHAM --
CREATE TABLE SANPHAM
(
   maSP int PRIMARY KEY,
   tenSP varchar(30),
   Gia int
)

-- TAO BANG CHI TIET HOA DON --
CREATE TABLE CHITIETHOADON
(
    maHD int NOT NULL,
    CONSTRAINT FK1_CHITIETHOADON FOREIGN KEY (maHD) REFERENCES HOADON(maHD),
    maSP int NOT NULL, 
    CONSTRAINT FK2_CHITIETHOADON FOREIGN KEY (maSP) REFERENCES SANPHAM(maSP),
    soLuong int
)

ALTER TABLE CHITIETHOADON
ADD PRIMARY KEY (maHD, maSP)

-- CHEN DU LIEU VAO BANG KHACH HANG --
INSERT INTO KHACHHANG(maKH, Ten, Tuoi, diaChi)
VALUES
(1, 'Le Minh Quan', 30, 'HaNoi'),
(2, 'Pham Ngoc Oanh', 20, 'Nam Dinh'),
(3, 'Le Hong Ha', 50, 'Ha Nam'),
(4, 'Nguyen Thu Trang', 20, 'Ha Noi'),
(5, 'Le Thu Hang', 35, 'Ha Noi'),
(6, 'Nguyen Anh Tai', 25, 'Ha Noi'),
(7, 'Pham Thu Ha', 18, 'Nam Dinh'),
(8, 'Le Van Tuan', 17, 'Phu Tho'),
(9, 'Nguyen Thi Duyen', 28, 'Phu Tho'),
(10, 'Dao Thu Lan', 31, 'Ha Noi')

-- CHEN DU LIEU VAO BANG HOA DON --
INSERT INTO HOADON(maHD, maKH, ngayMua, tongTien)
VALUES
(1, 1, '2021-03-21', 0),
(2, 2, '2021-03-23', 0),
(3, 1, '2021-03-16', 0),
(4, 1, '2021-03-16', 0),
(5, 1, '2021-03-20', 0)

-- CHEN DU LIEU VAO BANG SAN PHAM --
INSERT INTO SANPHAM(maSP, tenSP, Gia) 
VALUES
(1, 'May Giat', 3),
(2, 'Tu Lanh', 5),
(3, 'Dieu Hoa', 7),
(4, 'Quat', 1),
(5, 'Bep Dien', 2)

-- CHEN DU LIEU VAO BANG CHI TIET HOA DON --
INSERT INTO CHITIETHOADON(maHD, maSP, soLuong)
VALUES
(1, 1, 3),
(1, 3, 7),
(1, 4, 1),
(2, 1, 3),
(2, 5, 4),
(3, 1, 8)

-- XEM BANG --
SELECT * FROM KHACHHANG
SELECT * FROM HOADON
SELECT * FROM SANPHAM
SELECT * FROM CHITIETHOADON

-- CAU 1: SUA THONG TIN KHACH HANG MA 04 THANH DIA CHI NAM DINH --
UPDATE KHACHHANG SET diaChi = 'Nam Dinh' WHERE maKH = 4

-- CAU 2: THEM THONG TIN KHACH HANG --
INSERT INTO KHACHHANG(maKH, Ten, Tuoi, diaChi) VALUES(11, 'Pham Hai Anh', 35, 'Thai Binh')

-- CAU 3: SUA THONG TIN KHACH HANG LE THU HANG --
UPDATE KHACHHANG SET Tuoi = 30 WHERE Ten = 'Le Thu Hang'

-- CAU 4: SUA MA HOA DON 01 --
UPDATE HOADON SET ngayMua = '2022-3-21' WHERE maHD = 1

-- CAU 5: XOA KHACH HANG CO MA 011 --
DELETE FROM KHACHHANG WHERE maKH = 11

-- CAU 6: LAY RA THONG TIN SAU: TEN KHACH HANG, TUOI, DIA CHI TRONG BANG KHACH HANG --
SELECT Ten, Tuoi, diaChi
FROM KHACHHANG

-- CAU 7: LAY RA CAC THONG TIN SAU: MA HOA DON, MA SAN PHAM, TEN SAN PHAM, GIA --
SELECT HOADON.maHD, SANPHAM.maSP, tenSP, Gia FROM SANPHAM
JOIN CHITIETHOADON
ON SANPHAM.maSP = CHITIETHOADON.maSP
JOIN HOADON
ON CHITIETHOADON.maHD = HOADON.maHD

-- CAU 8: LAY RA TOP 3 DU LIEU DAU TIEN TRONG BANG KHACH HANG --
SELECT TOP(3) * FROM KHACHHANG

-- CAU 9: LAY RA CAC KHACH HANG CO DIA CHI O NAM DINH: THONG TIN BAO GOM MAKH, TENKH, TUOI, DIA CHI --
SELECT maKH, Ten, Tuoi, diaChi FROM KHACHHANG
WHERE diaChi = 'Nam Dinh'

-- CAU 10: LAY RA KHACH HANG CO TUOI > 30 O HA NOI: THONG TIN BAO GOM MAKH, TENKH, TUOI, DIA CHI --
SELECT maKH, Ten, Tuoi, diaChi FROM KHACHHANG
WHERE diaChi = 'Ha Noi' AND Tuoi > 30

-- CAU 11: DEM SO LUONG KHACH HANG O HA NOI --
SELECT COUNT(*) FROM KHACHHANG
WHERE diaChi = 'Ha Noi'

-- CAU 12: DEM SO LUONG HOA DON THEO NHOM TRONG BANG CHI TIET HOA DON --
SELECT CHITIETHOADON.maHD, COUNT(maHD) AS 'So Luong'
FROM CHITIETHOADON 
GROUP BY maHD
